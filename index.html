<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор доставки (Оновлений)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <div class="max-w-xl mx-auto p-6">
    <h1 class="text-2xl md:text-3xl font-bold mb-1">Калькулятор доставки</h1>
    <p class="text-gray-500 mb-6 text-sm">Вантажні перевезення по Україні</p>

    <section class="bg-white rounded-2xl shadow p-6 space-y-4">
      
      <div>
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Звідки</label>
        <input
          class="w-full mt-1 rounded-lg border-gray-200 bg-gray-100 border px-3 py-2 text-gray-600 cursor-not-allowed"
          value="Львів"
          disabled
        />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Населений пункт</label>
          <input
            id="destination"
            class="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            placeholder="Напр. Стрий"
          />
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Область</label>
          <input
            id="regionInput"
            class="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            placeholder="Напр. Львівська"
          />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Вага (кг)</label>
          <input
            id="weightKg"
            type="number"
            class="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 outline-none"
            placeholder="1200"
          />
        </div>
        <div>
          <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Довжина (м)</label>
          <input
            id="lengthM"
            type="number"
            step="0.1"
            class="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 outline-none"
            placeholder="4.5"
          />
        </div>
      </div>

      <div>
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Тип під'їзду</label>
        <select
          id="roadType"
          class="w-full mt-1 rounded-lg border border-gray-300 px-3 py-2 outline-none bg-white"
        >
          <option value="asphalt">Асфальт (Стандарт)</option>
          <option value="rocky">Кам'яниста / Гравій (+400 грн)</option>
          <option value="dirt">Ґрунтова / Бездоріжжя (+800 грн)</option>
        </select>
      </div>

      <div class="flex gap-3 pt-4">
        <button
          type="button"
          id="btnCalc"
          class="flex-1 bg-gray-900 text-white px-4 py-3 rounded-xl font-semibold hover:bg-black transition shadow-lg active:scale-95"
        >
          Розрахувати
        </button>
        <button
          type="button"
          id="btnReset"
          class="px-4 py-3 rounded-xl font-semibold border border-gray-300 text-gray-600 hover:bg-gray-50 transition"
        >
          Скинути
        </button>
      </div>

      <div id="errBox" class="hidden text-sm p-3 rounded-lg bg-red-50 text-red-700 border border-red-200"></div>
      
      <div id="capacityNote" class="hidden text-sm p-3 rounded-lg bg-yellow-50 text-yellow-800 border border-yellow-200"></div>

    </section>

    <aside id="resultBlock" class="hidden mt-6 bg-green-50 border border-green-200 rounded-2xl p-6 relative overflow-hidden transition-all">
      <div class="relative z-10">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-sm text-green-800 font-medium mb-1">Орієнтовна вартість:</div>
            <div id="totalPrice" class="text-4xl font-extrabold text-gray-900">0 грн</div>
          </div>
          <div id="routeTypeBadge" class="px-3 py-1 bg-white/80 backdrop-blur rounded-full text-xs font-bold text-gray-600 uppercase border border-gray-200 shadow-sm">
            Маршрут
          </div>
        </div>
        
        <div class="mt-4 space-y-1 text-sm text-gray-600 border-t border-green-200 pt-3">
          <div class="flex justify-between">
            <span>Відстань (Львів → Клієнт):</span>
            <span id="distVal" class="font-medium text-gray-900">0 км</span>
          </div>
          <div id="deviationRow" class="flex justify-between hidden text-orange-700">
            <span>+ Відхилення від хабу (×2):</span>
            <span id="devVal" class="font-medium">0 км</span>
          </div>
          <div id="zakarpattiaRow" class="hidden text-blue-700 font-medium mt-1">
            + 20% (Коефіцієнт Закарпаття)
          </div>
        </div>
      </div>
      <div class="absolute -right-6 -bottom-6 text-green-200 opacity-50">
        <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 7h-3V6a4 4 0 00-8 0v1H5a3 3 0 00-3 3v7a3 3 0 003 3h14a3 3 0 003-3v-5l-3-5zm-9-1a2 2 0 014 0v1h-4V6zm10 9a1 1 0 01-1 1H5a1 1 0 01-1-1V10a1 1 0 011-1h14a1 1 0 011 1v6z"/></svg>
      </div>
    </aside>
  </div>

  <script>
    // --- КОНФІГУРАЦІЯ ---
    const CONFIG = {
      pricePerKm: 14,
      minPrice: 2000,
      baseFee: 400, // Подача/збір
      zakarpattiaCoef: 1.2, // +20%
      hubRegions: ['волинська', 'рівненська', 'тернопільська'], // Де рахуємо відхилення в дві сторони
      routeRegions: ['львівська', 'волинська', 'рівненська', 'тернопільська', 'закарпатська'], // "По маршруту"
    };

    // Центри областей для розрахунку відхилення
    function getHubCity(regionNorm) {
      switch (regionNorm) {
        case 'волинська': return 'Луцьк, Україна';
        case 'рівненська': return 'Рівне, Україна';
        case 'тернопільська': return 'Тернопіль, Україна';
        default: return null;
      }
    }

    // --- УТИЛІТИ ---
    const U = {
      norm: (s) => s.toLowerCase().replace(/область|обл\.|обл/g, '').trim(),
      fmt: (n) => new Intl.NumberFormat('uk-UA').format(n),
    };

    // Специфічне заокруглення клієнта
    // 2100 -> 2000 | 2400 -> 2500 | 2700 -> 3000
    function smartRound(amount) {
      const thousands = Math.floor(amount / 1000) * 1000;
      const remainder = amount % 1000;

      if (remainder <= 250) {
        return thousands; // вниз до 000
      } else if (remainder <= 650) {
        return thousands + 500; // до 500
      } else {
        return thousands + 1000; // вверх до наступної 000
      }
    }

    // Google Maps API Loader
    let mapsReady = false;
    function initMaps() { mapsReady = true; }
    window.initMaps = initMaps;

    // --- ЛОГІКА РОЗРАХУНКУ ---
    async function calculate() {
      const els = {
        dest: document.getElementById('destination'),
        reg: document.getElementById('regionInput'),
        w: document.getElementById('weightKg'),
        l: document.getElementById('lengthM'),
        road: document.getElementById('roadType'),
        err: document.getElementById('errBox'),
        res: document.getElementById('resultBlock'),
        total: document.getElementById('totalPrice'),
        cap: document.getElementById('capacityNote'),
        badge: document.getElementById('routeTypeBadge'),
        distVal: document.getElementById('distVal'),
        devRow: document.getElementById('deviationRow'),
        devVal: document.getElementById('devVal'),
        zakRow: document.getElementById('zakarpattiaRow'),
      };

      // Скидання UI
      els.err.classList.add('hidden');
      els.res.classList.add('hidden');
      els.devRow.classList.add('hidden');
      els.zakRow.classList.add('hidden');

      const val = {
        city: els.dest.value.trim(),
        region: els.reg.value.trim(),
        regNorm: U.norm(els.reg.value),
        weight: +els.w.value || 0,
        len: +els.l.value || 0,
        road: els.road.value
      };

      if (!val.city || !val.region) {
        showError('Будь ласка, вкажіть місто та область.');
        return;
      }

      if (!mapsReady) {
        showError('Карта ще завантажується, спробуйте через секунду.');
        return;
      }

      // Визначення типу регіону
      const isHubRegion = CONFIG.hubRegions.includes(val.regNorm);
      const isZakarpattia = val.regNorm === 'закарпатська';
      const isRouteRegion = CONFIG.routeRegions.includes(val.regNorm);
      
      // Тип доставки (Текст бейджа)
      if (isRouteRegion) {
        els.badge.textContent = "По маршруту";
        els.badge.className = "px-3 py-1 bg-green-100 rounded-full text-xs font-bold text-green-700 uppercase border border-green-200";
      } else {
        els.badge.textContent = "Попутний транспорт";
        els.badge.className = "px-3 py-1 bg-blue-100 rounded-full text-xs font-bold text-blue-700 uppercase border border-blue-200";
      }

      try {
        // 1. Отримуємо основну дистанцію (Львів -> Клієнт)
        const totalKm = await getDistance('Львів, Україна', `${val.city}, ${val.region}, Україна`);
        els.distVal.textContent = totalKm.toFixed(1) + ' км';

        let billableKm = totalKm;
        
        // 2. Якщо це Hub-регіон (Волинь, Рівне, Тернопіль), рахуємо відхилення
        if (isHubRegion) {
          const hubCity = getHubCity(val.regNorm);
          // Відстань Хаб -> Клієнт
          const devKm = await getDistance(hubCity, `${val.city}, ${val.region}, Україна`);
          
          // Додаємо відхилення до оплачуваного кілометражу
          // (Логіка: Основний маршрут вже включає проїзд до клієнта,
          //  ми додаємо "зворотній шлях" відхилення або просто націнку за відхилення)
          billableKm += devKm;

          if (devKm > 1) {
            els.devRow.classList.remove('hidden');
            els.devVal.textContent = `+ ${devKm.toFixed(1)} км`;
          }
        }

        // 3. Базова вартість по кілометражу
        let price = billableKm * CONFIG.pricePerKm;

        // 4. Доплати (Вага, Довжина, Дорога, База)
        const surcharges = calculateSurcharges(val.weight, val.len, val.road);
        price += surcharges;
        price += CONFIG.baseFee;

        // 5. Закарпаття +20%
        if (isZakarpattia) {
          price = price * CONFIG.zakarpattiaCoef;
          els.zakRow.classList.remove('hidden');
        }

        // 6. Мінімалка
        if (price < CONFIG.minPrice) price = CONFIG.minPrice;

        // 7. Розумне заокруглення
        const finalPrice = smartRound(price);

        // Відображення
        els.total.textContent = U.fmt(finalPrice) + ' грн';
        els.res.classList.remove('hidden');

        // Перевірка обмежень транспорту
        checkCapacity(val.weight, val.len);

      } catch (e) {
        console.error(e);
        showError('Не вдалося розрахувати маршрут. Перевірте правильність написання міста.');
      }
    }

    // --- ДОПОМІЖНІ ФУНКЦІЇ ---

    function calculateSurcharges(kg, m, road) {
      let fee = 0;
      
      // Вага
      if (kg > 2000) fee += 2000;
      else if (kg > 1000) fee += 1000;
      else if (kg >= 800) fee += 800;
      else if (kg >= 500) fee += 500;

      // Довжина
      if (m >= 6) fee += 1000;
      else if (m >= 5) fee += 600;

      // Дорога
      if (road === 'dirt') fee += 800;
      if (road === 'rocky') fee += 400;

      return fee;
    }

    function checkCapacity(kg, m) {
      const box = document.getElementById('capacityNote');
      let warns = [];
      if (kg > 2500) warns.push("Вага > 2.5т (потрібен інший транспорт).");
      if (m > 6) warns.push("Довжина > 6м (негабарит).");
      
      if (warns.length > 0) {
        box.textContent = "Увага: " + warns.join(" ");
        box.classList.remove('hidden');
      } else {
        box.classList.add('hidden');
      }
    }

    function showError(msg) {
      const b = document.getElementById('errBox');
      b.textContent = msg;
      b.classList.remove('hidden');
    }

    // Обгортка для Google Maps Distance Matrix
    function getDistance(origin, dest) {
      return new Promise((resolve, reject) => {
        const svc = new google.maps.DistanceMatrixService();
        svc.getDistanceMatrix(
          {
            origins: [origin],
            destinations: [dest],
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
          },
          (res, status) => {
            if (status !== 'OK') return reject(status);
            const el = res.rows[0].elements[0];
            if (el.status !== 'OK') return reject(el.status);
            resolve(el.distance.value / 1000); // повертає км
          }
        );
      });
    }

    // Події
    document.getElementById('btnCalc').addEventListener('click', calculate);
    document.getElementById('btnReset').addEventListener('click', () => {
      document.getElementById('destination').value = '';
      document.getElementById('regionInput').value = '';
      document.getElementById('weightKg').value = '';
      document.getElementById('lengthM').value = '';
      document.getElementById('resultBlock').classList.add('hidden');
      document.getElementById('errBox').classList.add('hidden');
      document.getElementById('capacityNote').classList.add('hidden');
    });

  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFR9n0yr9SEPDWGyH1G_dDJBit7bxvy_Y&libraries=places&callback=initMaps" async defer></script>
</body>
</html>